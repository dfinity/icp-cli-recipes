name: Release Recipe

on:
  push:
    tags:
      - "rust-v*"
      - "motoko-v*"
      - "asset-canister-v*"
      - "prebuilt-v*"
      - "rust-latest"
      - "motoko-latest"
      - "assets-latest"
      - "prebuilt-latest"

permissions:
  contents: write

jobs:
  release-recipe:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Extract recipe and version from tag
        id: tag_info
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          RECIPE=$(echo $TAG | cut -d'-' -f1)
          VERSION=$(echo $TAG | cut -d'-' -f2-)

          # Handle latest tags specially
          if [[ "$VERSION" == "latest" ]]; then
            echo "recipe=$RECIPE" >> $GITHUB_OUTPUT
            echo "version=latest" >> $GITHUB_OUTPUT
            echo "is_latest=true" >> $GITHUB_OUTPUT
          else
            echo "recipe=$RECIPE" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_latest=false" >> $GITHUB_OUTPUT
          fi

      - name: Package Recipe
        run: |
          mkdir -p release

          # Copy individual recipe files
          cp recipes/${{ steps.tag_info.outputs.recipe }}/recipe.hbs release/

          # Create archives
          tar -czf release/${{ steps.tag_info.outputs.recipe }}-${{ steps.tag_info.outputs.version }}.tar.gz recipes/${{ steps.tag_info.outputs.recipe }}/
          zip -r release/${{ steps.tag_info.outputs.recipe }}-${{ steps.tag_info.outputs.version }}.zip recipes/${{ steps.tag_info.outputs.recipe }}/

      - name: Generate Checksums
        run: |
          cd release
          sha256sum * > checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@aec2ec56f94eb8180ceec724245f64ef008b89f5 # v2.4.0
        with:
          tag_name: ${{ steps.tag_info.outputs.recipe }}-${{ steps.tag_info.outputs.version }}
          name: ${{ steps.tag_info.outputs.recipe }} ${{ steps.tag_info.outputs.version }}
          files: release/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
